var app=angular.module("dbonyx",["AuctionCtrls","ItemCtrls","MenuCtrls","UserCtrls","ngRoute","ngCookies","ngAnimate"]);app.config(["$routeProvider","$locationProvider","$httpProvider",function(e,t,r){r.interceptors.push("AuthInterceptor"),e.when("/",{templateUrl:"app/views/index.html"}).when("/about",{templateUrl:"app/views/about.html"}).when("/auctions",{templateUrl:"app/views/auctions.html"}).when("/database",{templateUrl:"app/views/database.html"}).when("/character",{templateUrl:"app/views/character.html"}).when("/character/main",{templateUrl:"app/views/characterMain.html"}).when("/character/reputation",{templateUrl:"app/views/characterReputation.html"}).when("/character/achievements",{templateUrl:"app/views/characterAchievements.html"}).when("/character/mounts",{templateUrl:"app/views/characterMounts.html"}).when("/character/battlepets",{templateUrl:"app/views/characterBattlepets.html"}).when("/character/professions",{templateUrl:"app/views/characterProfessions.html"}).when("/character/pvp",{templateUrl:"app/views/characterPvp.html"}).when("/character/:characterName",{templateUrl:"app/views/character.html"}).when("/community",{templateUrl:"app/views/community.html"}).when("/feedback",{templateUrl:"app/views/feedback.html"}).when("/item/:id",{templateUrl:"app/views/item.html"}).when("/mount/:id",{templateUrl:"app/views/mount.html"}).when("/privacy",{templateUrl:"app/views/privacy.html"}).when("/profile",{controller:"userCtrl",templateUrl:"app/views/profile.html"}).when("/register",{templateUrl:"app/views/register.html"}).when("/terms",{templateUrl:"app/views/terms.html"}).when("/validate/:user/:validateString",{templateUrl:"app/views/validate.html"}).when("/forums",{controller:"forumCtrl",templateUrl:"app/views/forums/forumMain.html"}).when("/forums/cat/:categoryId",{controller:"forumCatCtrl",templateUrl:"app/views/forums/forumCategory.html"}).when("/forums/thread/:threadId",{controller:"forumThreadCtrl",templateUrl:"app/views/forums/forumThread.html"}).otherwise({templateUrl:"app/views/404.html"}),t.html5Mode(!0)}]).factory("onyxPersistence",["$cookies",function(e){var t,r={},a={};return r.setRealm=function(r){t=r,e.put("realm",r)},r.getRealm=function(){return t||e.get("realm")||""},r.set=function(t,r){a[t]=r,e.put(t,r)},r.get=function(t){return a[t]||e.get(t)||""},r}]).controller("mountCtrl",["$scope","$routeParams","$http",function(e,t,r){e.mountId=parseInt(t.id),e.mount={},e.loading=!0,e.mountId&&r({method:"GET",url:"/api/mount/"+e.mountId}).then(function(t){e.mount=t.data.mount},function(e){})}]).controller("feedbackCtrl",["$http","$scope",function(e,t){t.showForm=!0,t.sendFeedback=function(){t.error="",t.message&&t.title?e({url:"/api/user/feedback",method:"POST",data:{title:t.title,message:t.message}}).then(function(e){t.success="Your message has been sent successfully!",t.showForm=!1},function(e){t.error="There was an error sending your message, please try again."}):t.error="Please provide a title and a message."}}]).controller("watchlistCtrl",["$scope","$http",function(e,t){var r=function(){t({method:"GET",url:"/api/watchlist/"}).then(function(t){e.watchlists=t.data.watchlists},function(e){})};r(),e.watchlists=[]}]),angular.module("ItemCtrls",[]).factory("itemService",["$http",function(e){var t={};return t.getItem=function(r,a,n){var o=parseInt(r);return t.id===o?void n(t):void e({method:"GET",url:"/api/item/pretty/"+o,modifiers:a}).then(function(e){var t=e.data.item;n(t)},function(e){n(!1)})},t.prettify=function(e){},t}]).factory("itemAuctionService",["$http",function(e){var t={};return t.getItemAuctionDetails=function(t,r,a){e({method:"GET",url:"/api/auction/item/",params:{realm:r,id:t}}).then(function(e){alert("test1"),a(!0)},function(e){alert("test2"),a(!1)})},t}]).controller("itemCtrl",["$scope","$routeParams","itemService","itemAuctionService",function(e,t,r,a){e.id=t.id,e.auctionData=null,e.realmInput="",e.getItem=function(){e.item="Loading",e.loading=!0,r.getItem(e.id,{},function(t){console.log(t),e.item=t,e.loading=!1})},e.getAuctionDetails=function(){console.log(e),e.auctionLoading=!0,a.getItemAuctionDetails(e.id,e.realmInput,function(e){alert(e)})},e.getItem()}]).directive("itemDisplay",function(){var e=["$scope","itemService",function(e,t){e.getItem=function(){e.item="Loading",e.loading=!0,t.getItem(e.itemId,{},function(t){e.item=t,e.loading=!1})},e.getItem()}];return{controller:e,restrict:"E",replace:!0,scope:{itemId:"@"},templateUrl:"app/templates/itemDisplay.html"}}).directive("itemLink",[function(){var e=["$scope",function(e){e.quantity&&1!==parseInt(e.quantity)&&(e.showQuantity=!0)}];return{controller:e,scope:{item:"=",quantity:"@"},replace:!0,templateUrl:"app/templates/itemLink.html"}}]),angular.module("dbonyx").controller("searchBarCtrl",["$scope","searchBar",function(e,t){e.search=function(){t.search(e.searchTerm,function(t,r){return t?void(e.results=[]):void(e.results=r)})},e.clear=function(){e.searchTerm="",e.results=[]},e.hide=function(){setTimeout(function(){e.results=[],e.$apply()},100)},e.clear()}]).factory("searchBar",["$http",function(e){var t={};return t.results={},t.search=function(t,r){if(t.length<3)return r(!1,[]);var a={url:"/api/item/search/"+t};e(a).then(function(e){r(!1,e.data)},function(e){r(e.data.error)})},t}]),angular.module("UserCtrls",[]).factory("onyxUser",["$http","Auth",function(e,t){var r={loggedin:!1};return r.checkLoggedInStatus=function(){r.loggedin=t.isLoggedIn(),r.loggedin&&e({method:"POST",url:"/api/user/getUser"}).then(function(e){r.username=e.data.username,r.loggedin=!0},function(e){})},r.validateUser=function(t,r,a){e({method:"POST",url:"/api/user/validate",data:{username:t,validateString:r}}).then(function(e){return console.log("Success!"),e},function(e){return a("There was an error validating your email.")})},r.login=function(a,n,o){console.log("a"),e({method:"POST",url:"/api/user/login",data:{email:a,password:n}}).then(function(e){console.log(e),t.saveToken(e.data.token),r.username=e.data.username,r.email=e.data.email,r.loggedin=!0,o(null,!0)},function(e){console.log(e),o(e.data.error,!1)})},r.logout=function(){t.removeToken(),r.loggedin=!1,r.username=null,r.email=null},r.register=function(t,a,n,o,i){e({method:"POST",url:"/api/user/register",data:{username:t,email:a,password1:n,password2:o}}).then(function(e){r.login(a,n,function(e,t){i(!0)})},function(e){return i(null,e.data.error)})},r.checkLoggedInStatus(),r}]).factory("Auth",["$window",function(e){return{saveToken:function(t){e.localStorage["onyx-token"]=t},getToken:function(){return e.localStorage["onyx-token"]},removeToken:function(){return e.localStorage.removeItem("onyx-token")},isLoggedIn:function(){var e=this.getToken();return!!e}}}]).factory("AuthInterceptor",["Auth",function(e){return{request:function(t){var r=e.getToken();return r&&(t.headers.Authorization="JWT "+r),t}}}]).controller("validateCtrl",["$http","$location","$scope","$routeParams","onyxUser",function(e,t,r,a,n){n.validateUser(a.user,a.validateString,function(e){r.error=e})}]).controller("userCtrl",["onyxUser","$scope","$http","$location",function(e,t,r,a){t.user=e,t.showRegisterForm=!1,t.showUserPanel=!1,t.showRegisterForm=!1,t.toggleRegister=function(){t.showRegisterForm=!t.showRegisterForm},t.login=function(){e.login(t.login.email,t.login.password,function(e,r){t.login.email=null,t.login.password=null,e&&(t.error=e),t.showRegisterForm=!1})},t.logout=function(){e.logout(),t.user=e,t.showUserPanel=!1},t.toggleUserPanel=function(){t.showUserPanel=!t.showUserPanel},t.register=function(){e.register(t.username,t.email,t.password1,t.password2,function(e,r){e?(t.success="Registered Successfully!",t.toggleRegister()):r&&(t.registerError=r)})},t.clearError=function(){t.error=!1,t.registerError=!1,t.success=!1}}]).directive("userRegisterForm",[function(){return{restrict:"E",replace:!0,templateUrl:"app/templates/userRegisterForm.html"}}]).directive("userPanel",[function(){return{restrict:"E",replace:!0,templateUrl:"app/templates/userPanel.html"}}]),angular.module("AuctionCtrls",[]).controller("AuctionCtrl",["$scope","$http","$location","$routeParams","onyxPersistence","auctionService",function(e,t,r,a,n,o){var i=r.search();e.searchTerm=i.s||"",e.realmInput=i.r||n.getRealm()||"",e.validFilters=["Item Level","Required Level"],e.realms=[],e.auctionResults=o.auctionResults,e.loading=!1,e.filters=o.filters,e.qualities={values:[]},e.updatePages=function(){e.backPages=[],e.nextPages=[],e.low=o.resultLow,e.high=o.resultHigh;for(var t=o.currentPage-5;t<o.currentPage;t++)t>0&&e.backPages.push(t);for(var t=o.currentPage+1;t<=o.currentPage+5;t++)t<=o.resultPages&&e.nextPages.push(t);e.currentPage=o.currentPage},e.updatePage=function(t){o.updatePage(t),e.search()},e.firstPage=function(){o.firstPage(),e.search()},e.nextPage=function(){o.nextPage(),e.search()},e.backPage=function(){o.backPage(),e.search()},e.lastPage=function(){o.lastPage(),e.search()},e.clearQualityFilter=function(){e.qualities=[],e.firstPage()},e.setSortBy=function(t){o.setSortBy(t),e.search()},e.addFilter=function(){o.filters.push({type:"0",comparator:">",value:""})},e.removeFilter=function(e){o.filters.splice(e,1)};var c=function(t){e.loading=!1,e.auctionResults=o.auctionResults,e.updatePages()};e.search=function(t){t&&t.preventDefault(),e.loading=!0,o.qualities=e.qualities.values,o.filters=e.filters,o.setSearchTerm(e.searchTerm),o.setRealm(e.realmInput),o.search(c)},e.realmInput&&e.search()}]),angular.module("AuctionCtrls").directive("auctionResult",function(){var e=["$scope",function(e){e.toggleHistory=function(){e.showAuctionHistory=!e.showAuctionHistory}}];return{restrict:"E",replace:!0,controller:e,templateUrl:"app/templates/auctionResult.html"}}).directive("watchlistForm",function(){var e=["$scope","$http","onyxUser",function(e,t,r){e.user=r,e.minQuantity=1,e.item?e.maxQuantity=e.item.stackable||9999:e.maxQuantity=9999,e.price||(e.price=0),e.originalPrice=e.price,e.gold=Math.floor(e.price/1e4),e.silver=Math.floor(e.price%1e4/100),e.copper=e.price%100,e.submit=function(){var r=parseInt(e.copper+100*e.silver+1e4*e.gold);t({method:"POST",url:"/api/watchlist",data:{price:r,item:e.item._id,min:e.minQuantity,max:e.maxQuantity,realm:e.realmInput}}).then(function(e){},function(e){})}}];return{restrict:"E",controller:e,scope:{item:"=",price:"@",showWatchlist:"=",realmInput:"="},templateUrl:"app/templates/watchlist.html"}}).directive("auctionHistory",function(){var e=["$scope","auctionHistory",function(e,t){e.item&&t.search(e.item._id,e.realmInput,function(t,r){if(e.aucHistoryLoading=!1,t||!r)return t;e.histories=r.histories,e.count=e.histories.length,e.barwidth=Math.floor(480/e.count),e.barheight=280,e.width=e.barwidth*e.count;for(var a=0;a<e.histories.length;a++){var n=parseInt(e.histories[a].sellingPrice/e.histories[a].sold);e.histories[a].x=e.barwidth*a,e.histories[a].y=e.barheight-(e.barheight-25)*n/r.max,e.histories[a].averagePrice=n,e.histories[a].soldy=e.barheight+(40-40*(e.histories[a].sold/r.maxQuantity)),e.histories[a].soldheight=40*(e.histories[a].sold/r.maxQuantity),e.histories[a].expiredheight=40*(e.histories[a].expired/r.maxQuantity),e.histories[a].expiredy=e.histories[a].soldy-e.histories[a].expiredheight}}),e.aucHistoryLoading=!0,e.hoverIn=function(t){e.histories[t].selected=!0,e.selected=e.histories[t]},e.hoverOut=function(t){e.histories[t].selected=!1,e.selected=!1}}];return{restrict:"E",controller:e,scope:{item:"=",showAuctionHistory:"&",realmInput:"="},templateUrl:"app/templates/auctionHistory.html"}}),angular.module("AuctionCtrls").factory("auctionService",["$http",function(e){var t={searchTerm:"",realmInput:"",filters:[],qualities:[],sortBy:"buyout",sortOrder:-1,resultPages:0,currentPage:1,resultHigh:0,resultLow:0,limit:25,loading:!1,auctionResults:!1};return t.setSearchTerm=function(e){t.searchTerm=e},t.setRealm=function(e){t.realmInput=e},t.noMatch=function(){t.loading=!1,t.auctionResults=[],t.resultPages=0,t.resultLow=0,t.resultHigh=0},t.search=function(r){return t.realmInput.length?void e({method:"GET",url:"/api/auction/fetchauctions",params:{"qualities[]":t.qualities,"filters[]":t.filters,searchTerm:t.searchTerm,realm:t.realmInput,offset:(t.currentPage-1)*t.limit,limit:t.limit,sortBy:t.sortBy,sortOrder:t.sortOrder}}).then(function(e){t.loading=!1,t.auctionResults=e.data,t.resultPages=Math.ceil(t.auctionResults.count/t.limit),t.resultLow=(t.currentPage-1)*t.limit,t.resultHigh=t.resultLow+t.auctionResults.auctions.length,r(!0)},function(e){t.noMatch(),r(!1)}):(t.noMatch(),void r(!1))},t.setSortBy=function(e){t.sortBy===e?t.sortOrder*=-1:(t.sortBy=e,t.sortOrder=-1)},t.updatePage=function(e){e=parseInt(e),e>t.resultPages&&(e=t.resultPages),1>e&&(e=1),t.currentPage=e},t.firstPage=function(){t.updatePage(1)},t.backPage=function(){t.updatePage(t.currentPage-1)},t.nextPage=function(){t.updatePage(t.currentPage+1)},t.lastPage=function(){t.updatePage(t.resultPages)},t}]).factory("auctionHistory",["$http",function(e){var t={};return t.search=function(t,r,a){e({method:"GET",url:"/api/auction/auctionHistory",params:{item:t,realm:r}}).then(function(e){a(null,e.data)},function(e){a(e.data,null)})},t}]),angular.module("dbonyx").controller("characterCtrl",["onyxPersistence","onyxCharacter","$scope","$http","$location","$routeParams",function(e,t,r,a,n,o){r.character=t,r.search=function(e){e&&e.preventDefault;var t=o.characterName||r.characterName||"",a=r.realmInput||!1;r.character.search(t,a,function(e){e?1===e.count?n.url("/character/main"):r.results=e:r.error="Unable to find character."})},r.selectCharacter=function(a){t.setCharacter(r.results[a]),e.set("characterName",r.results[a].name),e.set("characterRealm",r.results[a].realm),e.set("characterRegion",r.results[a].region.toUpperCase()),$window.location.href="/character/main"},r.realmInput=e.get("characterRealm")+"-"+e.get("characterRegion"),r.characterName=e.get("characterName"),o.characterName&&(e.set("characterName",o.characterName),r.characterName=e.get("characterName"),r.search())}]).controller("characterMain",["onyxPersistence","onyxCharacter","$scope",function(e,t,r){r.character=t,r.character.get("items"),r.character.get("mounts"),r.character.get("achievements"),r.character.get("reputation")}]).controller("characterProfessions",["onyxCharacter","$scope",function(e,t){t.character=e,t.character.get("professions"),t.expandRecipes=[!1,!1,!1,!1,!1,!1],t.expandToggle=function(e){t.expandRecipes[e]=!t.expandRecipes[e]}}]),angular.module("dbonyx").factory("onyxCharacter",["$http","onyxPersistence",function(e,t){var r={},a=[];return r.loaded=!1,r.setCharacter=function(e){for(key in e)r[key]=e[key]},r.runOnLoad=function(){for(var e=0;e<a.length;e++)r.get(a[e])},r.search=function(a,n,o){if(r.loading=!0,!a)return r.loading=!1,void o(!1);var i={name:a};n&&(i.realm=n),e({method:"GET",url:"/api/character/load",params:i}).then(function(e){1===e.data.count?(t.set("characterName",a),t.set("characterRealm",e.data.character.realm),t.set("characterRegion",e.data.character.region),r.setCharacter(e.data.character),r.loading=!1,r.loaded=!0,r.runOnLoad(),o(e.data)):(r.loading=!1,o(e.data.characters))},function(e){r.loading=!1,t.set("characterName",""),o(!1)})},r.get=function(t){if(!r.loaded)return void a.push(t);if(!r[t]){if(!r.name||!r.realm||!r.region)return;var n={name:r.name,realm:r.realm,region:r.region};e({method:"GET",url:"/api/character/"+t,params:n}).then(function(e){r[t]=e.data[t]},function(e){})}},r.init=function(){var e=t.get("characterName"),a=t.get("characterRealm"),n=t.get("characterRegion"),o=a+"-"+n;"string"==typeof e&&""!==e&&r.search(e,o,function(e){})},r.init(),r}]),angular.module("dbonyx").controller("forumCtrl",["$scope","forumService",function(e,t){t.getCategories(function(t,r){t||(e.categories=r)})}]).controller("forumCatCtrl",["$scope","$routeParams","forumService",function(e,t,r){e.categoryId=t.categoryId,r.getCategory(e.categoryId,function(t,r){t||(e.category=r)}),e.newThread=function(){r.newThread(e.categoryId,e.title,e.message,function(e,t){console.log(e),console.log(t)})}}]).controller("forumThreadCtrl",["$scope","$routeParams","forumService",function(e,t,r){e.threadId=t.threadId,r.getThread(e.threadId,function(t,r){t||(e.thread=r)}),e.postMessage=function(){r.postMessage(e.threadId,e.message,function(e,t){console.log(e),console.log(t)})}}]).factory("forumService",["$http","Auth",function(e,t){var r={};return r.getCategories=function(t){e({url:"/api/forum/categories"}).then(function(e){t(null,e.data)},function(e){t(e.data)})},r.getCategory=function(t,r){e({url:"/api/forum/category/"+t}).then(function(e){r(null,e.data)},function(e){r(e.data)})},r.getThread=function(t,r){e({url:"/api/forum/thread/"+t}).then(function(e){r(null,e.data)},function(e){r(e.data)})},r.newThread=function(t,r,a,n){e({method:"POST",url:"/api/forum/category/"+t,data:{title:r,message:a}}).then(function(e){n(null,e.data)},function(e){n(e.data)})},r.postMessage=function(t,r,a){e({method:"POST",url:"/api/forum/thread/"+t,data:{message:r}}).then(function(e){a(null,e.data)},function(e){a(e.data)})},r}]),angular.module("dbonyx").directive("sidebar",[function(){return{restrict:"E",replace:!0,transclude:!0,templateUrl:"app/templates/sidebar.html"}}]).directive("mainContent",[function(){return{restrict:"E",replace:!0,transclude:!0,templateUrl:"app/templates/mainContent.html"}}]).directive("onyxFooter",[function(){return{templateUrl:"app/templates/footer.html"}}]).directive("selectOnFocus",["$window",function(e){return{restrict:"A",link:function(t,r,a){r.on("focus",function(){e.getSelection().toString()||this.setSelectionRange(0,this.value.length)})}}}]).directive("autoComplete",function(){var e=["onyxPersistence","$scope","$http",function(e,t,r){t.realmInputSelected=!1,t.realms=[],t.blurIn=function(e){0==t.realms.length&&t.getRealms(),t[e]=!0},t.blurOut=function(e){t[e]=!1},t.getRealms=function(){t.realms=["Loading Realms"],r({method:"GET",url:"/api/realms"}).then(function(e){t.realms=e.data},function(e){t.realms=["Unable to Load Realms"]})},t.selectRealm=function(r){t.realmInput=r,e.setRealm(r),setTimeout(t.search,0)},t.hover=function(e){t.hoverIndex=e}}];return{restrict:"E",replace:!0,scope:{realmInput:"=",search:"&"},templateUrl:"app/templates/autoComplete.html",controller:e}}).directive("money",function(){var e=["$scope",function(e){e.amount=parseInt(e.amount),e.copper=e.amount%100,e.silver=parseInt(e.amount/100)%100,e.gold=parseInt(e.amount/1e4)}];return{restrict:"E",replace:!0,scope:{amount:"="},templateUrl:"app/templates/money.html",controller:e}}),angular.module("MenuCtrls",[]).controller("MenuCtrl",["$scope",function(e){}]).directive("menuBar",[function(){var e=["$scope",function(e){var t;e.rehover=function(){e.hover=!0},e.menus=[],this.off=e.off=function(){e.hover=!1,t=setTimeout(function(){e.hover||(e.menuSelected=!1,e.$apply())},500)},this.addMenu=function(t){e.menus.push(t)}}];return{restrict:"E",transclude:!0,scope:{},controller:e,templateUrl:"app/templates/menuBar.html"}}]).directive("menu",[function(){return{require:"^^menuBar",restrict:"E",transclude:!0,scope:{title:"@",link:"@"},link:function(e,t,r,a){a.addMenu(e)},templateUrl:"app/templates/menu.html"}}]);